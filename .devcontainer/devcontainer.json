{
  "name": "Aspire-Full GPU Tensor Compute",
  "build": {
    "dockerfile": "Dockerfile",
    "context": "..",
    "args": {
      "BUILDKIT_INLINE_CACHE": "1"
    }
  },

  // GPU passthrough for CUDA/CU compute - 8GB RAM optimized with full privileges
  "runArgs": [
    "--privileged",
    "--gpus=all",
    "--memory=8g",
    "--memory-swap=10g",
    "--shm-size=2g",
    "--ulimit=memlock=-1:-1",
    "--ulimit=stack=67108864:67108864",
    "--ipc=host",
    "--cap-add=SYS_PTRACE",
    "--security-opt=seccomp=unconfined"
  ],

  // Named volumes for all persistent data - zero codebase pollution
  // Aligned with docker-compose.nvidia.yml for shared caching
  "mounts": [
    // Package caches - persist across rebuilds (shared with buildkit)
    { "type": "volume", "source": "aspire-nuget-cache", "target": "/volumes/nuget" },
    { "type": "volume", "source": "aspire-dotnet-cli", "target": "/volumes/dotnet-cli" },
    { "type": "volume", "source": "aspire-npm-cache", "target": "/volumes/npm" },
    { "type": "volume", "source": "aspire-uv-cache", "target": "/volumes/uv" },
    { "type": "volume", "source": "aspire-pip-cache", "target": "/volumes/pip" },
    // GPU/CUDA caches (shared with buildkit for zero-latency builds)
    { "type": "volume", "source": "aspire-cuda-cache", "target": "/volumes/cuda-cache" },
    { "type": "volume", "source": "aspire-nvidia-cache", "target": "/volumes/nvidia-cache" },
    { "type": "volume", "source": "aspire-ccache", "target": "/volumes/ccache" },
    // AI/ML model storage
    { "type": "volume", "source": "aspire-models", "target": "/volumes/models" },
    { "type": "volume", "source": "aspire-tensor-cache", "target": "/volumes/tensor-cache" },
    // Database storage
    { "type": "volume", "source": "aspire-qdrant", "target": "/volumes/qdrant" },
    // Build artifacts - keeps bin/obj out of workspace
    { "type": "volume", "source": "aspire-artifacts", "target": "/volumes/artifacts" },
    { "type": "volume", "source": "aspire-testresults", "target": "/volumes/testresults" },
    // Logs and temp
    { "type": "volume", "source": "aspire-logs", "target": "/volumes/logs" },
    { "type": "volume", "source": "aspire-tmp", "target": "/volumes/tmp" },
    // BuildKit cache (shared with buildkitd for layer reuse)
    { "type": "volume", "source": "aspire-buildkit-state", "target": "/var/lib/buildkit" }
  ],

  "features": {
    "ghcr.io/devcontainers/features/docker-in-docker:2": {
      "version": "latest",
      "moby": true
    }
  },

  "customizations": {
    "vscode": {
      "extensions": [
        "ms-dotnettools.csharp",
        "ms-dotnettools.csdevkit",
        "GitHub.copilot",
        "GitHub.copilot-chat",
        "ms-python.python",
        "ms-python.vscode-pylance",
        "charliermarsh.ruff"
      ],
      "settings": {
        "dotnet.defaultSolution": "Aspire-Full.slnx",
        "editor.formatOnSave": true,
        "files.exclude": {
          "**/bin": true,
          "**/obj": true,
          "**/.git": true,
          "**/node_modules": true,
          "**/__pycache__": true,
          "**/*.pyc": true
        },
        "files.watcherExclude": {
          "**/bin/**": true,
          "**/obj/**": true,
          "**/node_modules/**": true,
          "**/.git/objects/**": true
        }
      }
    }
  },

  "forwardPorts": [5000, 5001, 5432, 6379, 6333, 18888],
  "portsAttributes": {
    "5000": { "label": "API" },
    "5001": { "label": "Gateway" },
    "5432": { "label": "PostgreSQL", "onAutoForward": "silent" },
    "6379": { "label": "Redis", "onAutoForward": "silent" },
    "6333": { "label": "Qdrant", "onAutoForward": "silent" },
    "18888": { "label": "Aspire Dashboard", "onAutoForward": "openBrowser" }
  },

  "postCreateCommand": "dotnet restore && npm install --prefix Web/Aspire-Full.Web 2>/dev/null || true",
  "postStartCommand": "docker compose -f .devcontainer/docker-compose.yml up -d gpu-worker-1 gpu-worker-2 2>/dev/null || echo 'ðŸš€ GPU Workers: start manually with scripts/start-gpu-workers.ps1'",

  "remoteEnv": {
    "ASPIRE_ALLOW_UNSECURED_TRANSPORT": "true",
    "DOTNET_ENVIRONMENT": "Development",
    "ASPIRE_COMPUTE_MODE": "gpu",
    "ASPIRE_OFFLOAD_STRATEGY": "Full",
    "ASPIRE_FALLBACK_TO_CPU": "false",
    "ASPIRE_GPU_ONLY": "true",
    "PYTHON_GIL": "0",
    "ASPIRE_MAX_BATCH_SIZE": "64",
    "ASPIRE_ENABLE_DYNAMIC_BATCHING": "true",
    // Redirect build outputs to volumes
    "BaseOutputPath": "/volumes/artifacts/bin/",
    "BaseIntermediateOutputPath": "/volumes/artifacts/obj/",
    "VSTestResultsDirectory": "/volumes/testresults/"
  },

  "containerEnv": {
    "DOTNET_CLI_TELEMETRY_OPTOUT": "1",
    "DOTNET_NOLOGO": "1",
    "DOTNET_GCHeapHardLimit": "6871947674",
    "DOTNET_gcServer": "1",
    "DOTNET_TieredPGO": "1",
    "OMP_NUM_THREADS": "8",
    "OPENBLAS_NUM_THREADS": "8",
    // Volume paths
    "NUGET_PACKAGES": "/volumes/nuget",
    "DOTNET_CLI_HOME": "/volumes/dotnet-cli",
    "npm_config_cache": "/volumes/npm",
    "UV_CACHE_DIR": "/volumes/uv",
    "PIP_CACHE_DIR": "/volumes/pip",
    "CUDA_CACHE_PATH": "/volumes/cuda-cache"
  }
}
