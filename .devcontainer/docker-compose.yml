services:
  devcontainer:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      # Named volumes only - NO host mounts for complete isolation
      - aspire-nuget-cache:/home/vscode/.nuget
      - aspire-dotnet-tools:/home/vscode/.dotnet/tools
      - aspire-aspire-cli:/home/vscode/.aspire
      - aspire-vscode-extensions:/home/vscode/.vscode-server/extensions
      - aspire-workspace:/workspace
      - aspire-docker-certs:/certs
    environment:
      - DOTNET_CLI_TELEMETRY_OPTOUT=1
      - DOTNET_NOLOGO=1
      - DOTNET_RUNNING_IN_CONTAINER=true
      - NUGET_PACKAGES=/home/vscode/.nuget/packages
      - ASPIRE_ALLOW_UNSECURED_TRANSPORT=true
      - DOTNET_DASHBOARD_OTLP_ENDPOINT_URL=http://aspire-dashboard:18889
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://aspire-dashboard:18889
      # Docker-in-Docker connection
      - DOCKER_HOST=tcp://docker:2376
      - DOCKER_TLS_VERIFY=1
      - DOCKER_CERT_PATH=/certs/client
    networks:
      - aspire-network
    command: sleep infinity
    init: true
    depends_on:
      - docker

  # Docker-in-Docker service - isolated Docker daemon with named volume
  docker:
    image: docker:27-dind
    privileged: true
    volumes:
      - aspire-docker-data:/var/lib/docker
      - aspire-docker-certs:/certs
    environment:
      - DOCKER_TLS_CERTDIR=/certs
    networks:
      - aspire-network
    restart: unless-stopped

  aspire-dashboard:
    image: mcr.microsoft.com/dotnet/aspire-dashboard:latest
    container_name: aspire-dashboard
    ports:
      - "18888:18888"
      - "18889:18889"
    environment:
      - DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS=true
      - DASHBOARD__OTLP__AUTHMODE=Unsecured
      - DASHBOARD__FRONTEND__AUTHMODE=Unsecured
      - DASHBOARD__RESOURCESERVICE__AUTHMODE=Unsecured
    volumes:
      - aspire-dashboard-data:/app/data
    networks:
      - aspire-network
    restart: unless-stopped

volumes:
  aspire-nuget-cache:
    external: true
  aspire-dotnet-tools:
    external: true
  aspire-aspire-cli:
    external: true
  aspire-vscode-extensions:
    external: true
  aspire-workspace:
    external: true
  aspire-dashboard-data:
    external: true
  aspire-docker-data:
    external: true
  aspire-docker-certs:
    external: true

networks:
  aspire-network:
    external: true
