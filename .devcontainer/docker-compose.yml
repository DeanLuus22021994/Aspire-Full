services:
  devcontainer:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      # Named volumes only - NO host mounts for complete isolation
      - aspire-nuget-cache:/home/vscode/.nuget
      - aspire-dotnet-tools:/home/vscode/.dotnet/tools
      - aspire-aspire-cli:/home/vscode/.aspire
      - aspire-vscode-extensions:/home/vscode/.vscode-server/extensions
      - aspire-workspace:/workspace
      - aspire-docker-certs:/certs
    environment:
      - DOTNET_CLI_TELEMETRY_OPTOUT=1
      - DOTNET_NOLOGO=1
      - DOTNET_RUNNING_IN_CONTAINER=true
      - NUGET_PACKAGES=/home/vscode/.nuget/packages
      - ASPIRE_ALLOW_UNSECURED_TRANSPORT=true
      - DOTNET_DASHBOARD_OTLP_ENDPOINT_URL=http://aspire-dashboard:18889
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://aspire-dashboard:18889
      - ASPIRE_DASHBOARD_MCP_ENDPOINT_URL=http://aspire-dashboard:16036
      # Docker-in-Docker connection
      - DOCKER_HOST=tcp://docker:2376
      - DOCKER_TLS_VERIFY=1
      - DOCKER_CERT_PATH=/certs/client
    networks:
      - aspire-network
    command: sleep infinity
    init: true
    depends_on:
      - docker
      - aspire-dashboard

  # Self-hosted GitHub Actions Runner
  github-runner:
    build:
      context: .
      dockerfile: Dockerfile.runner
    container_name: aspire-github-runner
    volumes:
      # Named volumes for runner persistence
      - aspire-runner-data:/home/runner/actions-runner
      - aspire-runner-work:/home/runner/_work
      - aspire-runner-nuget:/home/runner/.nuget
      - aspire-runner-npm:/home/runner/.npm
      - aspire-runner-toolcache:/opt/hostedtoolcache
      - aspire-docker-certs:/certs:ro
    environment:
      # GitHub configuration (set via .env file or docker-compose override)
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY:-DeanLuus22021994/Aspire-Full}
      - RUNNER_NAME=${RUNNER_NAME:-aspire-runner}
      - RUNNER_LABELS=${RUNNER_LABELS:-self-hosted,Linux,X64,docker,dotnet,aspire}
      - RUNNER_GROUP=${RUNNER_GROUP:-Default}
      - RUNNER_WORKDIR=/home/runner/_work
      # .NET configuration
      - DOTNET_CLI_TELEMETRY_OPTOUT=1
      - DOTNET_NOLOGO=1
      - DOTNET_RUNNING_IN_CONTAINER=true
      - NUGET_PACKAGES=/home/runner/.nuget/packages
      # Docker-in-Docker connection
      - DOCKER_HOST=tcp://docker:2376
      - DOCKER_TLS_VERIFY=1
      - DOCKER_CERT_PATH=/certs/client
      # Tool cache for GitHub Actions
      - RUNNER_TOOL_CACHE=/opt/hostedtoolcache
      - AGENT_TOOLSDIRECTORY=/opt/hostedtoolcache
    networks:
      - aspire-network
    restart: unless-stopped
    depends_on:
      - docker
      - aspire-dashboard

  # Docker-in-Docker service - isolated Docker daemon with named volume
  docker:
    image: docker:27-dind
    privileged: true
    volumes:
      - aspire-docker-data:/var/lib/docker
      - aspire-docker-certs:/certs
    environment:
      - DOCKER_TLS_CERTDIR=/certs
    networks:
      - aspire-network
    restart: unless-stopped

  aspire-dashboard:
    image: mcr.microsoft.com/dotnet/aspire-dashboard:latest
    container_name: aspire-dashboard
    ports:
      - "18888:18888"
      - "18889:18889"
      - "16036:16036"
    environment:
      - DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS=true
      - DASHBOARD__OTLP__AUTHMODE=Unsecured
      - DASHBOARD__FRONTEND__AUTHMODE=Unsecured
      - DASHBOARD__RESOURCESERVICE__AUTHMODE=Unsecured
      # MCP Server configuration for Copilot integration
      - ASPIRE_DASHBOARD_MCP_ENDPOINT_URL=http://0.0.0.0:16036
      - ASPIRE_ALLOW_UNSECURED_TRANSPORT=true
    volumes:
      - aspire-dashboard-data:/app/data
    networks:
      - aspire-network
    restart: unless-stopped

  # PostgreSQL database for API
  postgres:
    image: postgres:17-alpine
    container_name: aspire-postgres
    volumes:
      - aspire-postgres-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=aspire
      - POSTGRES_PASSWORD=aspire_dev_password
      - POSTGRES_DB=aspire
    ports:
      - "5432:5432"
    networks:
      - aspire-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aspire -d aspire"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis cache
  redis:
    image: redis:7-alpine
    container_name: aspire-redis
    volumes:
      - aspire-redis-data:/data
    ports:
      - "6379:6379"
    networks:
      - aspire-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: redis-server --appendonly yes

volumes:
  aspire-nuget-cache:
    external: true
  aspire-dotnet-tools:
    external: true
  aspire-aspire-cli:
    external: true
  aspire-vscode-extensions:
    external: true
  aspire-workspace:
    external: true
  aspire-dashboard-data:
    external: true
  aspire-docker-data:
    external: true
  aspire-docker-certs:
    external: true
  # GitHub Actions Runner volumes
  aspire-runner-data:
    external: true
  aspire-runner-work:
    external: true
  aspire-runner-nuget:
    external: true
  aspire-runner-npm:
    external: true
  aspire-runner-toolcache:
    external: true
  # Database volumes
  aspire-postgres-data:
    external: true
  aspire-redis-data:
    external: true

networks:
  aspire-network:
    external: true
