services:
  devcontainer:
    build:
      context: ..
      dockerfile: Aspire-Full.DockerRegistry/docker/Dev/Dockerfile.DevContainer
    volumes:
      # SINGLE HOST MOUNT - All persistent storage through /shared
      - type: bind
        source: ${SHARED_HOST_PATH:-C:/SHARED}
        target: /shared
        read_only: false
      # Named volumes for dev environment caches (container-internal, non-persistent)
      - aspire-nuget-cache:/home/vscode/.nuget
      - aspire-dotnet-tools:/home/vscode/.dotnet/tools
      - aspire-aspire-cli:/home/vscode/.aspire
      - aspire-vscode-extensions:/home/vscode/.vscode-server/extensions
      - aspire-workspace:/workspace
      - aspire-docker-certs:/certs
      - aspire-uv-cache:/home/vscode/.cache/uv
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: ["gpu", "utility"]
    environment:
      - DOTNET_CLI_TELEMETRY_OPTOUT=1
      - DOTNET_NOLOGO=1
      - DOTNET_RUNNING_IN_CONTAINER=true
      - NUGET_PACKAGES=/home/vscode/.nuget/packages
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - NVIDIA_REQUIRE_CUDA=cuda>=12.4,driver>=535
      - ASPIRE_ALLOW_UNSECURED_TRANSPORT=true
      # Telemetry configuration - send to standalone dashboard
      - DOTNET_DASHBOARD_OTLP_ENDPOINT_URL=http://aspire-dashboard:18889
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://aspire-dashboard:18889
      - ASPIRE_DASHBOARD_MCP_ENDPOINT_URL=http://aspire-dashboard:16036
      # BuildKit connection (for GPU-accelerated builds)
      - BUILDKIT_HOST=tcp://docker:1234
      - DOCKER_BUILDKIT=1
    networks:
      - aspire-network
    command: sleep infinity
    init: true
    depends_on:
      - docker
      - aspire-dashboard

  # Self-hosted GitHub Actions Runner
  github-runner:
    build:
      context: ..
      dockerfile: Aspire-Full.DockerRegistry/docker/Dev/Dockerfile.Runner
    container_name: aspire-github-runner
    volumes:
      # Named volumes for runner persistence
      - aspire-runner-data:/home/runner/actions-runner
      - aspire-runner-work:/home/runner/_work
      - aspire-runner-nuget:/home/runner/.nuget
      - aspire-runner-npm:/home/runner/.npm
      - aspire-runner-toolcache:/opt/hostedtoolcache
      - aspire-docker-certs:/certs:ro
    environment:
      # GitHub configuration (set via .env file or docker-compose override)
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY:-DeanLuus22021994/Aspire-Full}
      - RUNNER_NAME=${RUNNER_NAME:-aspire-runner}
      - RUNNER_LABELS=${RUNNER_LABELS:-self-hosted,Linux,X64,docker,dotnet,aspire}
      - RUNNER_GROUP=${RUNNER_GROUP:-Default}
      - RUNNER_WORKDIR=/home/runner/_work
      # .NET configuration
      - DOTNET_CLI_TELEMETRY_OPTOUT=1
      - DOTNET_NOLOGO=1
      - DOTNET_RUNNING_IN_CONTAINER=true
      - NUGET_PACKAGES=/home/runner/.nuget/packages
      # BuildKit connection (for GPU-accelerated builds)
      - BUILDKIT_HOST=tcp://docker:1234
      - DOCKER_BUILDKIT=1
      # Tool cache for GitHub Actions
      - RUNNER_TOOL_CACHE=/opt/hostedtoolcache
      - AGENT_TOOLSDIRECTORY=/opt/hostedtoolcache
    networks:
      - aspire-network
    restart: unless-stopped
    depends_on:
      - docker
      - aspire-dashboard

  # ─────────────────────────────────────────────────────────────────────────────
  # NVIDIA BuildKit - GPU-accelerated Docker build daemon
  # ─────────────────────────────────────────────────────────────────────────────
  docker:
    image: moby/buildkit:master
    privileged: true
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: ["gpu", "utility", "compute"]
    volumes:
      - aspire-docker-data:/var/lib/docker
      - aspire-docker-certs:/certs
      - aspire-buildkit-cache:/var/lib/buildkit
      - aspire-ccache:/root/.ccache
      - aspire-cuda-cache:/var/cache/cuda
      - aspire-uv-cache:/root/.cache/uv
      - ../Aspire-Full.DockerRegistry/docker/buildkitd.toml:/etc/buildkit/buildkitd.toml:ro
    environment:
      - DOCKER_TLS_CERTDIR=/certs
      - BUILDKIT_HOST=tcp://0.0.0.0:1234
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - NVIDIA_REQUIRE_CUDA=cuda>=12.4,driver>=535
    entrypoint:
      - buildkitd
      - --addr=tcp://0.0.0.0:1234
      - --addr=unix:///run/buildkit/buildkitd.sock
      - --config=/etc/buildkit/buildkitd.toml
    networks:
      - aspire-network
    restart: unless-stopped

  # =============================================================================
  # Aspire Dashboard - Standalone telemetry collector
  # =============================================================================
  # NOTE: PostgreSQL, Redis, pgAdmin, and Redis Commander are managed by
  # the Aspire AppHost (Aspire-Full/AppHost.cs) - NOT by Docker Compose.
  # This prevents duplicate containers and port conflicts.
  # =============================================================================
  aspire-dashboard:
    image: mcr.microsoft.com/dotnet/aspire-dashboard:latest
    container_name: aspire-dashboard
    ports:
      - "18888:18888"
      - "18889:18889"
      - "16036:16036"
    environment:
      - DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS=true
      - DASHBOARD__OTLP__AUTHMODE=Unsecured
      - DASHBOARD__FRONTEND__AUTHMODE=Unsecured
      - DASHBOARD__RESOURCESERVICE__AUTHMODE=Unsecured
      - ASPIRE_DASHBOARD_MCP_ENDPOINT_URL=http://0.0.0.0:16036
      - ASPIRE_ALLOW_UNSECURED_TRANSPORT=true
    volumes:
      - aspire-dashboard-data:/app/data
    networks:
      - aspire-network
    restart: unless-stopped

  github-mcp:
    build:
      context: ..
      dockerfile: Aspire-Full.DockerRegistry/docker/Mcp/Dockerfile.GithubMcp.Cuda
    container_name: aspire-github-mcp
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: ["gpu", "utility"]
    environment:
      - GITHUB_MCP_TOKEN=${GITHUB_MCP_TOKEN}
      - GITHUB_MCP_REPOSITORY=${GITHUB_MCP_REPOSITORY:-DeanLuus22021994/Aspire-Full}
      - GITHUB_MCP_API_KEY=${GITHUB_MCP_API_KEY:-aspire-github-mcp}
      - GITHUB_MCP_CACHE_SECONDS=45
      - ASPIRE_DASHBOARD_URL=http://aspire-dashboard:18888
      - ASPIRE_DASHBOARD_MCP_ENDPOINT_URL=http://aspire-dashboard:16036
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - NVIDIA_REQUIRE_CUDA=cuda>=12.4,driver>=535
    ports:
      - "17071:17071"
    volumes:
      - aspire-github-mcp-data:/opt/github-mcp/data
      - aspire-github-mcp-logs:/var/log/github-mcp
      - aspire-github-mcp-cache:/home/node/.cache/github-mcp
    networks:
      - aspire-network
    restart: unless-stopped
    depends_on:
      - aspire-dashboard

  # =============================================================================
  # GPU Automation Workers - Python 3.15t Free-Threaded with CuPy
  # 2 x 1GB VRAM workers + 1GB Qdrant = 3GB total VRAM allocation
  # Privileged access for direct GPU compute, zero-latency kernel dispatch
  # =============================================================================
  gpu-worker-1:
    image: mcr.microsoft.com/devcontainers/python:3.12
    container_name: aspire-gpu-worker-1
    privileged: true
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: ["gpu", "utility", "compute"]
        limits:
          memory: 4g
    environment:
      - PYTHON_GIL=0
      - ASPIRE_WORKER_ID=1
      - ASPIRE_WORKER_VRAM_MB=2048
      - ASPIRE_GPU_ONLY=true
      - ASPIRE_COMPUTE_MODE=gpu
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - NVIDIA_REQUIRE_CUDA=cuda>=12.4,driver>=535
      - CUDA_VISIBLE_DEVICES=0
      - AGENT_POOL_MODE=hot-standby
      - AGENT_WARMUP_ON_START=true
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://aspire-dashboard:18889
    volumes:
      - aspire-models:/volumes/models:ro
      - aspire-uv-cache:/volumes/uv
      - aspire-cuda-cache:/volumes/cuda-cache
      - aspire-logs:/volumes/logs
      - type: bind
        source: ${SHARED_HOST_PATH:-C:/SHARED}
        target: /shared
        read_only: false
    networks:
      - aspire-network
    restart: unless-stopped
    command: sleep infinity
    depends_on:
      - aspire-dashboard

  gpu-worker-2:
    image: mcr.microsoft.com/devcontainers/python:3.12
    container_name: aspire-gpu-worker-2
    privileged: true
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: ["gpu", "utility", "compute"]
        limits:
          memory: 4g
    environment:
      - PYTHON_GIL=0
      - ASPIRE_WORKER_ID=2
      - ASPIRE_WORKER_VRAM_MB=2048
      - ASPIRE_GPU_ONLY=true
      - ASPIRE_COMPUTE_MODE=gpu
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - NVIDIA_REQUIRE_CUDA=cuda>=12.4,driver>=535
      - CUDA_VISIBLE_DEVICES=0
      - AGENT_POOL_MODE=hot-standby
      - AGENT_WARMUP_ON_START=true
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://aspire-dashboard:18889
    volumes:
      - aspire-models:/volumes/models:ro
      - aspire-uv-cache:/volumes/uv
      - aspire-cuda-cache:/volumes/cuda-cache
      - aspire-logs:/volumes/logs
      - type: bind
        source: ${SHARED_HOST_PATH:-C:/SHARED}
        target: /shared
        read_only: false
    networks:
      - aspire-network
    restart: unless-stopped
    command: sleep infinity
    depends_on:
      - aspire-dashboard
      - gpu-worker-1

# =============================================================================
# Named Volumes
# =============================================================================
# Database volumes (aspire-postgres-data, aspire-redis-data) are created
# automatically by Aspire AppHost when running `dotnet run --project Aspire-Full`
# =============================================================================
volumes:
  aspire-nuget-cache:
    external: true
  aspire-dotnet-tools:
    external: true
  aspire-aspire-cli:
    external: true
  aspire-vscode-extensions:
    external: true
  aspire-workspace:
    external: true
  aspire-dashboard-data:
    external: true
  aspire-docker-data:
    external: true
  aspire-docker-certs:
    external: true
  # BuildKit + CUDA cache volumes
  aspire-buildkit-cache:
    external: true
  aspire-ccache:
    external: true
  aspire-cuda-cache:
    external: true
  # GitHub Actions Runner volumes
  aspire-runner-data:
    external: true
  aspire-runner-work:
    external: true
  aspire-runner-nuget:
    external: true
  aspire-runner-npm:
    external: true
  aspire-runner-toolcache:
    external: true
  aspire-github-mcp-data:
    external: true
  aspire-github-mcp-logs:
    external: true
  aspire-github-mcp-cache:
    external: true
  aspire-uv-cache:
    external: true
  # GPU Worker volumes
  aspire-models:
    external: true
  aspire-logs:
    external: true

networks:
  aspire-network:
    external: true
