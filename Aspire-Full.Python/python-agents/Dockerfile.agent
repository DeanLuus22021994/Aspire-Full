# syntax=docker/dockerfile:1
FROM python:3.14-rc-slim
LABEL org.opencontainers.image.source="https://github.com/Dean/Aspire-Full"
LABEL org.opencontainers.image.description="Aspire Full Python Agents"
LABEL org.opencontainers.image.licenses="MIT"

# Enable Python 3.14 Free-Threading
# ENV PYTHON_GIL=0
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Enable apt caching
RUN rm -f /etc/apt/apt.conf.d/docker-clean; echo 'Binary::apt::APT::Keep-Downloaded-Packages "true";' > /etc/apt/apt.conf.d/keep-cache

# Install system dependencies for audio, video, and browser
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    git \
    libportaudio2 \
    libasound2-dev \
    ffmpeg

# Install uv for fast package management
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

# Set working directory
WORKDIR /app

# Copy dependency files
# Note: These paths are relative to the build context (repo root)
COPY Aspire-Full.Python/python-agents/pyproject.toml Aspire-Full.Python/python-agents/uv.lock* Aspire-Full.Python/python-agents/README.md ./

# Install dependencies
# We use --system because we are in a container
RUN --mount=type=cache,target=/root/.cache/uv \
    uv pip install --system --no-cache-dir -e .[tracing]

# Install Playwright browsers
RUN --mount=type=cache,target=/root/.cache/ms-playwright \
    uv run playwright install --with-deps chromium

# Copy source code
COPY Aspire-Full.Python/python-agents/ .

# Pre-download models for instant readiness
# This runs the script we just created to cache models in the image
RUN python scripts/download_models.py

# Expose port
EXPOSE 8000

# Run the server
CMD ["python", "src/aspire_agents/examples/realtime/app/server.py"]
