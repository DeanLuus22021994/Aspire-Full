# Syntax=docker/dockerfile:1

# Stage 1: Builder (Compile dependencies and models)
# Use NVIDIA CUDA Devel image to ensure CUDA libraries are available for any source builds
FROM nvidia/cuda:12.6.0-devel-ubuntu24.04 AS builder

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=0 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    DEBIAN_FRONTEND=noninteractive

WORKDIR /build

# Install Python 3.11 and system dependencies
# Python 3.11 is selected for maximum compatibility with PyTorch CUDA wheels
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common \
    && add-apt-repository ppa:deadsnakes/ppa \
    && apt-get update && apt-get install -y --no-install-recommends \
    python3.11 \
    python3.11-dev \
    python3.11-venv \
    python3-pip \
    build-essential \
    git \
    libportaudio2 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set Python 3.11 as default
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1 \
    && update-alternatives --install /usr/bin/python python /usr/bin/python3.11 1

# Install pip
RUN curl -sS https://bootstrap.pypa.io/get-pip.py | python3

# Install Python dependencies
COPY AI/Aspire-Full.Python/python-agents/pyproject.toml .

# Install PyTorch with CUDA 12.4 support
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu124

RUN --mount=type=cache,target=/root/.cache/pip \
    pip install \
        transformers \
        openai-agents \
        fastapi \
        uvicorn \
        uvloop \
        openai \
        typer \
        rich \
        pydantic \
        PyYAML \
        httpx \
        tenacity \
        mcp \
        websockets \
        python-dotenv \
        sounddevice \
        textual \
        numpy \
        pandas \
        sqlalchemy \
        psycopg2-binary \
        redis \
        azure-identity \
        azure-keyvault-secrets \
        dapr-ext-grpc \
        dapr-ext-fastapi \
        dapr-client \
        twilio \
        playwright

# Install Playwright browsers (heavy operation, but required for computer use tools)
RUN playwright install --with-deps chromium

# Pre-download models to cache
RUN --mount=type=cache,target=/root/.cache/huggingface \
    python -c "from transformers import AutoTokenizer, AutoModel; \
    model_name = 'sentence-transformers/all-MiniLM-L6-v2'; \
    AutoTokenizer.from_pretrained(model_name); \
    AutoModel.from_pretrained(model_name)"

# Explicitly compile all installed packages for maximum startup performance
RUN python -m compileall /usr/local/lib/python3.11

# Stage 2: Runtime (Minimal, GPU-optimized)
FROM nvidia/cuda:12.6.0-runtime-ubuntu24.04 AS runtime
LABEL org.opencontainers.image.source="https://github.com/Dean/Aspire-Full"
LABEL org.opencontainers.image.description="Aspire Full Tensor Compute Service"
LABEL org.opencontainers.image.licenses="MIT"

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    DEBIAN_FRONTEND=noninteractive

WORKDIR /app

# Install runtime system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common \
    && add-apt-repository ppa:deadsnakes/ppa \
    && apt-get update && apt-get install -y --no-install-recommends \
    python3.11 \
    python3.11-venv \
    libgomp1 \
    libportaudio2 \
    && rm -rf /var/lib/apt/lists/*

# Set Python 3.11 as default
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1 \
    && update-alternatives --install /usr/bin/python python /usr/bin/python3.11 1

# Copy installed packages from builder
COPY --from=builder /usr/local/lib/python3.11 /usr/local/lib/python3.11
COPY --from=builder /usr/local/bin /usr/local/bin

# Copy model cache (transformers default cache is usually ~/.cache/huggingface)
# We'll move it to a shared volume location in entrypoint or just bake it in
COPY --from=builder /root/.cache/huggingface /root/.cache/huggingface

# Copy application code
COPY AI/Aspire-Full.Python/python-agents/ .

# Precompile application code for instant startup
RUN python -m compileall .

# Create non-root user
RUN useradd -m -u 1000 aspire
USER aspire

# Environment variables for strict GPU usage
ENV NVIDIA_VISIBLE_DEVICES=all \
    NVIDIA_DRIVER_CAPABILITIES=compute,utility \
    TORCH_CUDA_ARCH_LIST="7.0 7.5 8.0 8.6 8.9 9.0+PTX"

# Entrypoint script to verify environment and start
COPY --chown=aspire:aspire AI/Aspire-Full.Python/python-agents/scripts/run_agent.ps1 /app/scripts/run_agent.ps1

# Default command (can be overridden)
CMD ["python", "-m", "aspire_agents.cli", "--help"]
