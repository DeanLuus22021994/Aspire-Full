# syntax=docker/dockerfile:1
# =============================================================================
# Aspire Python Agents - Python 3.15t Free-Threaded with TensorCore Compute
# Enhanced for Agent & Sub-Agent Orchestration with GPU Tensor Offload
# Build with: docker buildx bake python-agents
# =============================================================================
# hadolint global ignore=DL3008,DL3013
FROM nvidia/cuda:13.0.0-cudnn-devel-ubuntu24.04 AS builder
LABEL org.opencontainers.image.source="https://github.com/Dean/Aspire-Full"
LABEL org.opencontainers.image.description="Aspire Python Agents 3.15t (Free-Threaded) with TensorCore"
LABEL org.opencontainers.image.licenses="MIT"
LABEL ai.aspire.agent.version="1.0.0"
LABEL ai.aspire.agent.capabilities="orchestration,subagent,semantic-kernel,mcp,tensor-offload"

# =============================================================================
# Python 3.15 Free-Threading + TensorCore + Agent Compute Configuration
# Enhanced for multi-agent orchestration with sub-agent tensor offload
# =============================================================================
ENV PYTHON_GIL=0 \
    PYTHON_JIT=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONIOENCODING=utf-8 \
    PYTHONHASHSEED=random \
    # NVIDIA TensorCore Configuration
    NVIDIA_VISIBLE_DEVICES=all \
    NVIDIA_DRIVER_CAPABILITIES=compute,utility \
    TORCH_CUDA_ARCH_LIST="7.0 7.5 8.0 8.6 8.9 9.0+PTX" \
    CUDA_TENSOR_CORE_ALIGNMENT=128 \
    # Microsoft Pyright Configuration (strict type checking)
    PYRIGHT_PYTHON_VERSION=3.15 \
    PYRIGHT_TYPE_CHECKING_MODE=strict \
    # Agent & Sub-Agent TensorCore Compute
    ASPIRE_AGENT_THREAD_POOL_SIZE=8 \
    ASPIRE_SUBAGENT_MAX_CONCURRENT=16 \
    ASPIRE_TENSOR_BATCH_SIZE=32 \
    ASPIRE_TENSOR_OFFLOAD_ENABLED=1 \
    ASPIRE_SUBAGENT_GPU_SHARE=1 \
    ASPIRE_COMPUTE_MODE=hybrid \
    # PyTorch TensorCore optimizations
    PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True,max_split_size_mb:512" \
    TORCH_COMPILE_MODE=reduce-overhead \
    # uv configuration
    UV_COMPILE_BYTECODE=1 \
    UV_LINK_MODE=copy

# Enable apt caching
RUN rm -f /etc/apt/apt.conf.d/docker-clean; \
    echo 'Binary::apt::APT::Keep-Downloaded-Packages "true";' > /etc/apt/apt.conf.d/keep-cache

# Install system dependencies
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    git \
    libportaudio2 \
    libsndfile1 \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

# Install uv (Astral's ultra-fast Python package manager)
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /usr/local/bin/

# Install Python 3.15t (free-threaded)
RUN uv python install 3.15t

# Set working directory
WORKDIR /app

# =============================================================================
# Bake ALL dependencies into the image with strict formatting
# Copy pyproject.toml and uv.lock for reproducible builds
# =============================================================================
COPY AI/Aspire-Full.Python/python-agents/pyproject.toml \
     AI/Aspire-Full.Python/python-agents/uv.lock ./

# Create virtual environment with Python 3.15t
RUN uv venv /opt/venv --python 3.15t

# Activate venv and install ALL dependencies with CUDA support
# PyTorch is installed from the CUDA 12.6 nightly index for TensorCore optimization
RUN --mount=type=cache,target=/root/.cache/uv \
    . /opt/venv/bin/activate && \
    uv sync --frozen --all-extras

# Install Microsoft Pyright type checker (strict mode for Agent code quality)
RUN --mount=type=cache,target=/root/.cache/uv \
    . /opt/venv/bin/activate && \
    uv pip install pyright>=1.1.407 mypy>=1.13.0 types-requests>=2.31.0 types-PyYAML>=6.0.12

# Install additional Agent & Sub-Agent orchestration dependencies
RUN --mount=type=cache,target=/root/.cache/uv \
    . /opt/venv/bin/activate && \
    uv pip install \
    dapr>=1.14.0 \
    grpcio>=1.68.0 \
    protobuf>=5.29.0 \
    accelerate>=1.2.0

# Pre-install Playwright browsers (heavy but necessary for computer use)
RUN . /opt/venv/bin/activate && playwright install --with-deps chromium

# Pre-download transformer models for instant startup
RUN --mount=type=cache,target=/root/.cache/huggingface \
    . /opt/venv/bin/activate && \
    python -c "from transformers import AutoTokenizer, AutoModel; \
    model_name = 'sentence-transformers/all-MiniLM-L6-v2'; \
    AutoTokenizer.from_pretrained(model_name); \
    AutoModel.from_pretrained(model_name)"

# Copy source code
COPY AI/Aspire-Full.Python/python-agents/ .

# Install the project itself in editable mode
RUN --mount=type=cache,target=/root/.cache/uv \
    . /opt/venv/bin/activate && \
    uv pip install -e .[tracing]

# Create cache directories for Agent compute
RUN mkdir -p /var/cache/semantic-kernel /var/cache/torch-inductor && \
    chmod -R 777 /var/cache/semantic-kernel /var/cache/torch-inductor

# Create Microsoft Pyright configuration for Agent code quality
RUN mkdir -p /etc/python && \
    echo '{"pythonVersion":"3.15","pythonPlatform":"Linux","typeCheckingMode":"strict","include":["src"],"exclude":["**/__pycache__","**/.venv","**/dist","**/build"],"strictListInference":true,"strictDictionaryInference":true,"strictSetInference":true,"reportMissingImports":"error","reportUnusedImport":"error","reportMissingTypeArgument":"error"}' > /etc/python/pyrightconfig.json

# Precompile all Python files for instant startup
RUN . /opt/venv/bin/activate && python -m compileall -q .

# =============================================================================
# Runtime Stage - Minimal image with all dependencies baked in
# Optimized for Agent & Sub-Agent TensorCore inference
# =============================================================================
FROM nvidia/cuda:13.0.0-cudnn-runtime-ubuntu24.04 AS runtime
LABEL org.opencontainers.image.source="https://github.com/Dean/Aspire-Full"
LABEL org.opencontainers.image.description="Aspire Python Agents Runtime with TensorCore"
LABEL org.opencontainers.image.licenses="MIT"
LABEL ai.aspire.agent.version="1.0.0"
LABEL ai.aspire.agent.capabilities="inference,subagent,semantic-kernel,mcp,tensor-offload"

ENV PYTHON_GIL=0 \
    PYTHON_JIT=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONIOENCODING=utf-8 \
    # NVIDIA TensorCore Configuration
    NVIDIA_VISIBLE_DEVICES=all \
    NVIDIA_DRIVER_CAPABILITIES=compute,utility \
    CUDA_TENSOR_CORE_ALIGNMENT=128 \
    # Virtual environment
    PATH="/opt/venv/bin:$PATH" \
    VIRTUAL_ENV="/opt/venv" \
    # Agent & Sub-Agent TensorCore Compute
    ASPIRE_AGENT_THREAD_POOL_SIZE=8 \
    ASPIRE_SUBAGENT_MAX_CONCURRENT=16 \
    ASPIRE_TENSOR_BATCH_SIZE=32 \
    ASPIRE_TENSOR_OFFLOAD_ENABLED=1 \
    ASPIRE_SUBAGENT_GPU_SHARE=1 \
    ASPIRE_COMPUTE_MODE=gpu \
    # PyTorch TensorCore optimizations
    PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True,max_split_size_mb:512" \
    TORCH_COMPILE_MODE=reduce-overhead

# Install runtime dependencies only
RUN apt-get update && apt-get install -y --no-install-recommends \
    libportaudio2 \
    libsndfile1 \
    ffmpeg \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy virtual environment from builder
COPY --from=builder /opt/venv /opt/venv

# Copy Playwright browsers
COPY --from=builder /root/.cache/ms-playwright /root/.cache/ms-playwright

# Copy HuggingFace model cache
COPY --from=builder /root/.cache/huggingface /root/.cache/huggingface

# Copy application code (precompiled and formatted)
COPY --from=builder /app .

# Create non-root user
RUN useradd -m -u 1000 aspire
USER aspire

# Expose port
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import httpx; httpx.get('http://localhost:8000/health')" || exit 1

# Run the server
CMD ["python", "src/aspire_agents/examples/realtime/app/server.py"]
