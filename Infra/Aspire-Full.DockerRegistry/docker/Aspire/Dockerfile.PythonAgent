# syntax=docker/dockerfile:1
# Build the base image first:
# docker build -f Infra/Aspire-Full.DockerRegistry/docker/Dockerfile.base-playwright -t aspire-python-playwright:latest .
FROM aspire-python-playwright:latest
LABEL org.opencontainers.image.source="https://github.com/Dean/Aspire-Full"
LABEL org.opencontainers.image.description="Aspire Full Python Agents"
LABEL org.opencontainers.image.licenses="MIT"

# Enable Python 3.14 Free-Threading
# ENV PYTHON_GIL=0
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Set working directory
WORKDIR /app

# Copy dependency files
# Note: These paths are relative to the build context (repo root)
COPY AI/Aspire-Full.Python/python-agents/pyproject.toml AI/Aspire-Full.Python/python-agents/uv.lock* ./

# Install dependencies
# We use --system because we are in a container
# We use --prerelease=allow to ensure we get the latest bleeding edge versions compatible with 3.14
RUN --mount=type=cache,target=/root/.cache/uv \
    uv export --frozen --format requirements-txt --extra tracing --no-emit-project --output-file requirements.txt && \
    uv pip install --system --no-cache-dir --prerelease=allow -r requirements.txt

# Copy source code
COPY AI/Aspire-Full.Python/python-agents/ .

# Install the project itself
RUN --mount=type=cache,target=/root/.cache/uv \
    uv pip install --system --no-cache-dir --prerelease=allow -e .[tracing]

# Pre-download models for instant readiness
# This runs the script we just created to cache models in the image
RUN python scripts/download_models.py

# Expose port
EXPOSE 8000

# Run the server
CMD ["python", "src/aspire_agents/examples/realtime/app/server.py"]
