debug = false
root = "/var/lib/buildkit"

# ─────────────────────────────────────────────────────────────────────────────
# OCI Worker Configuration - PRIVILEGED GPU with Maximum BuildKit Performance
# Optimized for extremely low latency builds with full CUDA access
# ─────────────────────────────────────────────────────────────────────────────
[worker.oci]
  enabled = true
  gc = true
  gckeepstorage = 100000000000  # 100GB for aggressive caching

  # NVIDIA Container Runtime - Privileged GPU access
  runtime = "nvidia"
  runtimeArgs = [
    "--privileged",
    "--gpus=all",
    "--ipc=host",
    "--ulimit=memlock=-1:-1",
    "--ulimit=stack=67108864:67108864"
  ]

  # Multi-arch builds
  platforms = ["linux/amd64", "linux/arm64"]

  # Maximum parallelism for low-latency builds
  maxParallelism = 8

  # Snapshot pool for faster layer extraction
  snapshotter = "overlayfs"

  # Network mode for build containers
  networkMode = "host"

  # ─────────────────────────────────────────────────────────────────────────────
  # Garbage Collection Policies - Aggressive caching for low latency
  # ─────────────────────────────────────────────────────────────────────────────
  [[worker.oci.gcpolicy]]
    # Keep source and exec caches indefinitely up to 40GB
    keepBytes = 40000000000  # 40GB
    keepDuration = 2592000   # 30 days
    filters = ["type==source.local", "type==exec.cachemount", "type==source.git.checkout"]

  [[worker.oci.gcpolicy]]
    # CUDA compilation caches - keep forever (critical for low latency)
    keepBytes = 30000000000  # 30GB
    keepDuration = 7776000   # 90 days
    filters = ["type==exec.cachemount"]

  [[worker.oci.gcpolicy]]
    # Layer cache - keep recent builds hot
    keepBytes = 20000000000  # 20GB
    keepDuration = 1209600   # 14 days
    filters = ["type==regular"]

  [[worker.oci.gcpolicy]]
    all = true
    keepBytes = 100000000000 # 100GB total

# ─────────────────────────────────────────────────────────────────────────────
# Named Volume Cache Mounts - Persist all caches for zero-latency rebuilds
# ─────────────────────────────────────────────────────────────────────────────

# CUDA/GPU caches
[[worker.oci.cachemount]]
  path = "/var/cache/cuda"
  type = "bind"
  source = "aspire-cuda-cache"

[[worker.oci.cachemount]]
  path = "/root/.nv"
  type = "bind"
  source = "aspire-nvidia-cache"

# Build tool caches
[[worker.oci.cachemount]]
  path = "/root/.ccache"
  type = "bind"
  source = "aspire-ccache"

[[worker.oci.cachemount]]
  path = "/root/.cache/go-build"
  type = "bind"
  source = "aspire-gobuild-cache"

# Package manager caches
[[worker.oci.cachemount]]
  path = "/root/.nuget/packages"
  type = "bind"
  source = "aspire-nuget-cache"

[[worker.oci.cachemount]]
  path = "/root/.cache/uv"
  type = "bind"
  source = "aspire-uv-cache"

[[worker.oci.cachemount]]
  path = "/root/.cache/pip"
  type = "bind"
  source = "aspire-pip-cache"

[[worker.oci.cachemount]]
  path = "/root/.npm"
  type = "bind"
  source = "aspire-npm-cache"

# APT cache for base image rebuilds
[[worker.oci.cachemount]]
  path = "/var/cache/apt"
  type = "bind"
  source = "aspire-apt-cache"

# ─────────────────────────────────────────────────────────────────────────────
# Registry Configuration - Local registry for fast pushes
# ─────────────────────────────────────────────────────────────────────────────
[registry."host.docker.internal:5001"]
  http = true
  insecure = true
  mirrors = ["localhost:5001"]

[registry."localhost:5001"]
  http = true
  insecure = true

# ─────────────────────────────────────────────────────────────────────────────
# gRPC Server - Low latency frontend communication
# ─────────────────────────────────────────────────────────────────────────────
[grpc]
  address = ["unix:///run/buildkit/buildkitd.sock", "tcp://0.0.0.0:1234"]
  # Enable reflection for debugging
  debugAddress = "0.0.0.0:6060"

# ─────────────────────────────────────────────────────────────────────────────
# Frontend - Use gateway for maximum layer reuse
# ─────────────────────────────────────────────────────────────────────────────
[frontend."dockerfile.v0"]
[frontend."gateway.v0"]
